# config/default.yaml
# Step configuration + script paths for the flat pipeline

run:
  output_dir: run
  snapshot_dir: run/snapshots
  data_dir: run/data
  eval_dir: eval_out
  contract: contract.json
  catalog: catalog.json
  experiments_csv: experiments.csv
  artifacts: artifacts.json
  model: microsoft/Phi-3-mini-4k-instruct
  format_policy: data/format_policy.json
  policy: generation_policy.json
  report: data_report.json
  fused_dir: run/fused_model
  generations: generations
  tokmeta: tokenizer_meta
  ablations: ablation_generations
  summary: summary
  analysis: analysis

# ---- Step Definitions ------------------------------------------------------

manifest:
  run: scripts/00_manifest.py
  seed: 42

fetch_hf_dataset:
  run: scripts/01_fetch_hf_dataset.py
  hf_dataset: asuender/motivational-quotes
  subset: quotes
  mode: "sft"
  valid_fract: 0.02
  min_words: 5
  max_words: 60
  seed: 42

prepare_prompts:
  run: scripts/022_prepare_prompts.py
  valid_fraction: 0.02
  min_words: 5
  max_words: 60
  template_name: plain_text_passthrough
  stop_strings: ["</s>", "###", "Instruction:", "Response:"]
  use_eos_token: true


prepare_experiments:
  run: scripts/023_prepare_experiments.py
  contract: run/data/data_contract.json
  epochs: 3
  batch_size: 2
  grad_accum: 8
  max_seq_length: 512
  learning_rate: 0.0002
  bf16: true
  iters_override: 10 #smoke test limit

prepare_data:
  run: scripts/02_prepare_data.py

register:
  run: scripts/031_register.py
  dataset_jsonl: run/data/train.jsonl

train:
  run: scripts/03_train.py
  dry_run: false
  only_model_id: ""
  only_row: None
  steps_per_report: 1000
  steps_per_eval: 5000
  val_batches: 1

fuse:
  run: scripts/032_fuse.py
  do_fuse: true
  q_bits: 4
  q_group: 64
  dtype: "float16"
  dry_run: false

snapshot:
  run: scripts/04_snapshot.py
  fused: fused/model
  quant: quantized
  max_new: 128
  alt_seed: 7
  n_shots: 3
  min_words: 3
  retries: 2
  prompts:
    - "Tell us who lives in the house of the three gunas."
    - "Offer a short proverb on patience."
    - "Give a hopeful saying for a widow."

examination:
  run: scripts/042_examination.py
  ablations: ablation_generations
  report: report.md
  recreate: repro.sh
  analysis: eos_analysis
  summary: eos_summary
  prompts:
    - "Tell us who lives in the house of the three gunas."
    - "Offer a short proverb on patience."
    - "Give a hopeful saying for a widow."

extract_md_for_voice:
  run: scripts/092_extract_md_for_voice.py
  input_md: your.md
  valid_fraction: 0.1
  min_story_words: 40

crawl_for_voice:
  run: scripts/091_crawl_for_voice.coffee
  base: some_domain.com
  output_dir: run/data
  valid_fraction: 0.1
  min_story_words: 50

crawl_for_voice_continuation:
  run: scripts/093_crawl_for_voice_continuation.coffee
  base: some_domain.com
  output_dir: run/data
  valid_fraction: 0.1
  min_story_words: 50
  max_examples_per_story: 6

extract_keywords_kag:
  run: scripts/043_extract_keywords_kag.coffee
  input_jsonl: out_kag.jsonl
  output_jsonl: out_kag_keywords.jsonl
