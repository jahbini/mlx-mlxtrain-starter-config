###
# daily.yaml — daily oracle → LoRA trainer → safetensor accumulator
###

# -------------------------------------------------------------------
# Global run-level configuration
# -------------------------------------------------------------------

run:
  model: microsoft/Phi-3-mini-4k-instruct

  stories_md: /Users/theaiguy/jim_stories/jim.md

  marshalled_stories: data/marshalled_stories.jsonl
  marshalled_segments: data/marshalled_segments.jsonl
  stories: data/stories.jsonl

  kag_emotions: data/kag_emotions.jsonl
  kag_examples: data/kag_examples.jsonl
  merged_segments: data/merged_segments.jsonl

  train_file: loraland/train.jsonl
  valid_file: loraland/valid.jsonl
  test_file:  loraland/test.jsonl
  loraLand:   loraland        # where LoRA safetensors are written
  adapter_safetensors: loraland/adapter/adapters.safetensors
  finalized_tensor: out/finalized.safetensor

  contract: data_contract.json
  catalog: data_catalog.json
  report: data_report.json
  prompt_policy: prompt_policy.json
  experiments_csv: experiments.csv
  artifacts: artifacts.json
  tokmeta: tokenizer_meta.json

  output_dir: out
  data_dir: data
  eval_dir: eval_out


# -------------------------------------------------------------------
# Steps — full DAG definition
# -------------------------------------------------------------------

md2segments:
  desc: "Convert markdown corpus → clean jsonl segments"
  run: kag_oracle/md2segments.coffee
  depends_on: []
  input_md: /Users/theaiguy/jim_stories/jim.md
  split_mode: paragraph


oracle_ask:
  desc: "Query MLX emotion oracle on N untagged segments"
  run: kag_oracle/oracle_ask.coffee
  depends_on: [md2segments]
  batch_size: 10


reply_merge:
  desc: "Merge oracle replies with matching story segments"
  run: kag_oracle/reply_merge.coffee
  depends_on: [oracle_ask]


rotate_merged:
  desc: "Rotate: merged→train; old train→append→valid"
  run: kag_oracle/rotate_merged.coffee
  depends_on: [reply_merge]


lora_train:
  desc: "Run incremental LoRA on today’s new examples"
  run: kag_oracle/lora_train.coffee
  depends_on: [rotate_merged]
  epochs: 1
  batch_size: 1
  grad_accum: 8
  max_seq_length: 768
  learning_rate: 1e-4
  iters: 100
  bf16: false


finalize_tensors:
  desc: "Accumulate new LoRA deltas into long-lived safetensors"
  run: kag_oracle/finalize_tensors.coffee
  depends_on: [lora_train]
  # Optional config knobs (*you may remove until needed*)
  finalized_path: loraland/finalized.safetensors
  last_run_path: loraland/last_run.safetensors
  fan_in: additive     # additive updates for deltas
